{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block content %}
  <div class="container mt-5">
    <h1 class="mb-5 text-primary fw-bold border-bottom pb-3"><i class="fas fa-chart-line me-2"></i> {% trans "Suivi de Prospection pour l'Entreprise" %}: {{ entreprise.nom }}</h1>

    <div class="row">
      {# Section 1: Informations de l'Entreprise #}
      <div class="col-lg-4 col-md-6 mb-4">
        <div class="card shadow-lg h-100 border-primary rounded-4">
          <div class="card-header bg-primary text-white rounded-top-4">
            <h5 class="mb-0"><i class="fas fa-building me-2"></i> {% trans "Détails de l'Entreprise" %}</h5>
          </div>
          <div class="card-body">
            <p class="mb-2">
              <strong><i class="fas fa-industry me-2 text-primary"></i> {% trans 'Secteur' %}:</strong> {{ entreprise.secteur_activite|default:'Non spécifié' }}
            </p>
            <p class="mb-2">
              <strong><i class="fas fa-map-marker-alt me-2 text-primary"></i> {% trans 'Adresse' %}:</strong> {{ entreprise.adresse|default:'-' }}
            </p>
            <p class="mb-2">
              <strong><i class="fas fa-location-arrow me-2 text-primary"></i> {% trans 'Délégation' %}:</strong> {{ entreprise.delegation|default:'-' }}
            </p>
            <p class="mb-2">
              <strong><i class="fas fa-user-circle me-2 text-primary"></i> {% trans 'Contact' %}:</strong> {{ entreprise.contact|default:'-' }}
            </p>
            <p class="mb-2">
              <strong><i class="fas fa-phone me-2 text-primary"></i> {% trans 'Téléphone' %}:</strong> {{ entreprise.telephone|default:'-' }}
            </p>
          </div>
          <div class="card-footer text-end">
            <a href="{% url 'entreprise:modifier_entreprise' pk=entreprise.pk %}" class="btn btn-sm btn-outline-primary"><i class="fas fa-edit me-1"></i> {% trans "Modifier l'Entreprise" %}</a>
          </div>
        </div>
        <!-- Bouton de retour vers la vue de détail de l'entreprise -->
        <div class="mt-3 text-center">
          {% comment %}Assurez-vous d'avoir une URL nommée 'detail_entreprise' ou similaire dans vos urls.py{% endcomment %}
          <a href="{% comment %} {% url 'entreprise:detail_entreprise' pk=entreprise.pk %} {% endcomment %}#" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left me-1"></i> {% trans 'Retour aux détails' %}</a>
        </div>
      </div>

      {# Section 2: Ajout d'un Nouveau Suivi #}
      <div class="col-lg-8 col-md-6 mb-4">
        <div class="card shadow-lg h-100 border-success rounded-4">
          <div class="card-header bg-success text-white rounded-top-4">
            <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i> {% trans 'Ajouter un Nouvel Événement de Suivi' %}</h5>
          </div>
          <div class="card-body">
            {# LIGNE 51 CORRIGÉE: L'URL doit pointer vers elle-même. Si l'erreur se produit ici, assurez-vous que la vue POST renvoie toujours l'objet 'entreprise' avec son 'pk'. #}
            <form action="{% url 'entreprise:entreprise_prospection_detail' pk=entreprise.pk %}" method="post">
              {% csrf_token %}

              {% if form_suivi.non_field_errors %}
                <div class="alert alert-danger" role="alert">
                  {% for error in form_suivi.non_field_errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}

              <div class="mb-3">
                <label for="{{ form_suivi.etat.id_for_label }}" class="form-label fw-bold">{% trans 'Nouvel État' %}</label>
                {{ form_suivi.etat }}
                {% if form_suivi.etat.errors %}
                  <div class="text-danger small">{{ form_suivi.etat.errors }}</div>
                {% endif %}
              </div>

              <div class="mb-3">
                <label for="{{ form_suivi.notes.id_for_label }}" class="form-label fw-bold">{% trans 'Notes de Suivi' %}</label>
                {{ form_suivi.notes }}
                {% if form_suivi.notes.errors %}
                  <div class="text-danger small">{{ form_suivi.notes.errors }}</div>
                {% endif %}
              </div>

              <div class="d-flex justify-content-end mt-4">
                <button type="submit" class="btn btn-success"><i class="fas fa-save me-1"></i> {% trans 'Enregistrer le Suivi' %}</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <hr class="my-4" />

    {# Section 3: Liste des Suivis de Prospection #}
    <div class="row mt-4">
      <div class="col-12">
        <div class="card shadow-lg border-0 rounded-4">
          <div class="card-header bg-secondary text-white rounded-top-4 py-3">
            <h5 class="mb-0"><i class="fas fa-history me-2"></i> {% trans 'Historique des Suivis de Prospection' %}({{ prospections_list.count }})</h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-striped table-hover mb-0">
                <thead class="bg-light">
                  <tr>
                    <th style="width: 15%">
                      {% trans 'Date du Suivi' %}
                    </th>
                    <th style="width: 20%">
                      {% trans 'État' %}
                    </th>
                    <th style="width: 55%">
                      {% trans 'Notes Détaillées' %}
                    </th>
                    <th style="width: 10%" class="text-center">
                      {% trans 'Actions' %}
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {% for prospection in prospections_list %}
                    <tr>
                      <td>{{ prospection.date_suivi|date:'d M Y' }}</td>
                      <td>
                        {% with state=prospection.etat|lower %}
                          {% if state == 'a_contacter' %}
                            <span class="badge bg-danger"><i class="fas fa-exclamation-circle me-1"></i> {{ prospection.get_etat_display }}</span>
                          {% elif state == 'contact_fait' %}
                            <span class="badge bg-warning text-dark"><i class="fas fa-phone-alt me-1"></i> {{ prospection.get_etat_display }}</span>
                          {% elif state == 'rendez_vous' %}
                            <span class="badge bg-info"><i class="fas fa-calendar-check me-1"></i> {{ prospection.get_etat_display }}</span>
                          {% elif state == 'qualifie' %}
                            <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i> {{ prospection.get_etat_display }}</span>
                          {% elif state == 'perdu' %}
                            <span class="badge bg-secondary"><i class="fas fa-times-circle me-1"></i> {{ prospection.get_etat_display }}</span>
                          {% else %}
                            <span class="badge bg-dark">{{ prospection.get_etat_display }}</span>
                          {% endif %}
                        {% endwith %}
                      </td>
                      <td>{{ prospection.notes|default:'Aucune note enregistrée.' }}</td>
                      <td class="text-center">
                        <!-- Bouton Modifier -->
                        <a href="{% url 'entreprise:modifier_prospection' pk=prospection.pk %}" class="btn btn-sm btn-outline-info" title="Modifier le Suivi"><i class="bi bi-pencil-square"></i></a>

                        <!-- Bouton Supprimer -->
                        <a href="{% url 'entreprise:supprimer_prospection' pk=prospection.pk %}" class="btn btn-sm btn-outline-danger ms-1" onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce suivi ?');" title="Supprimer le Suivi"><i class="bi bi-trash"></i></a>
                      </td>
                    </tr>
                  {% empty %}
                    <tr>
                      <td colspan="4" class="text-center py-4 text-muted">
                        <i class="fas fa-inbox me-2"></i> {% trans 'Aucun suivi de prospection enregistré pour cette entreprise. Commencez-en un !' %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="text-center mt-5">
      {% comment %}Assurez-vous d'avoir une URL nommée 'prospection_liste' ou similaire dans vos urls.py{% endcomment %}
      <a href="{% comment %} {% url 'entreprise:prospection_liste' %} {% endcomment %}#" class="btn btn-secondary"><i class="fas fa-arrow-left me-1"></i> {% trans 'Retour à la Liste de Prospection' %}</a>
    </div>
  </div>
{% endblock %}
